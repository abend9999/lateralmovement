# Lateral Movement (横展開)

https://attack.mitre.org/wiki/Lateral_Movement でLateral Movementの手法に関して記載されたものを翻訳しました。

## Tactic Description

横展開は攻撃者がネットワークやクラウド上のリモートシステムにアクセスし制御を可能にする技術から成り立っており、必要ではないがリモートシステム上でツールの実行を含むことができます。横展開の技術により攻撃者はリモートアクセスツールなどの追加のツールを必要とせずにシステムから情報収集することができます。

攻撃者はツールのリモート実行、追加システムへのピボット、特定の情報またはファイルへのアクセス、追加の資格情報へのアクセスまたは効果を引き起こすなど、様々な目的のために横展開を悪用します。攻撃者のツールへリモートからアクセスさせるための機能としてリモートからスクリプトやコードを実行させますが、攻撃者はリモートからシステムに接続するために内在するネットワークやOSの機能とともにネットワーク上で正当な資格情報を使用してツールのフットプリントを減らします。

あるシステムから別のシステムへのネットワーク移動が攻撃者の目標を達成するために必要となる場合があります。したがって、横展開や横展開に頼る手法は、攻撃者がネットワーク内で利用する攻撃者の能力セットや情報とアクセスの依存関係の幅広いセットの一部が非常に重要となります。本質的なセキュリティの依存関係を理解するために、ネットワーク上のすべてのシステムでアカウントとアクセス権限の関係を把握することが重要です。横展開は攻撃者にとって常に求められることではないです。もし攻撃者が最初のシステムにアクセスして目標を達成できたら、ネットワーク全体への追加の移動は不要になります。


## Technique
#### AppleScript

macOSやOS Xのアプリケーションはプロセス間通信(IPC)を行うために、AppleEventメッセージを相互に送信します。これらのメッセージはローカルまたはリモートのIPCのためにAppleScriptで容易にスクリプト化できます。OsascriptはAppleScriptやその他のOpen Scripting Architecture(OSA)言語スクリプトで実行されます。システムにインストールされているOSA言語のリストは、OSA言語のプログラムで見つけることができます。
AppleEventメッセージは独立して送信することやスクリプトの一部として送信することもできます。これらのイベントは開いているウィンドウの検索、キーストロークの送信、ローカルまたはリモートでほとんどのオープンなアプリケーションと通信することができます。

攻撃者はオープンになっているSSHコネクションを利用して、リモートのPCに侵入したり偽のダイアログボックスを表示させたりできます。これらのイベントはリモートからアプリケーションを開始することはできません(ローカルでは開始することができます)。ですが、リモートで既に動いているアプリケーションとは通信が可能です。スクリプト言語であるため、python2経由でリバースシェルのように一般的な手法で起動することもできます。スクリプトは「osascript /path/to/script」や「osascript -e "script here"」のように実行可能です。


#### Application Deployment Software

攻撃者は企業の管理者が使用する展開されたアプリケーションを利用してネットワーク内のシステムに不正なソフトウェアを展開することができます。展開するための権限はシステム構成によって異なります。展開するサーバに直接アクセスできる場合はローカルの資格情報で十分な場合や特定ドメインの資格情報が必要な場合があります。ただ、管理者権限を持つアカウントでのログインや展開を行うことを求められる場合があります。ネットワーク規模または企業規模へ展開されたアプリケーションにアクセスすることで攻撃者はリモートから接続されたすべてのシステムでコードを実行できます。システムへの横展開に利用されたり、情報収集やすべてのエンドポイントのハードディスクから情報が消去されるなどの被害を受けます。


#### Distributed Component Object Model

Windows Distributed Component Object Model (DCOM)はRPCを用いてローカル環境からCOMの機能を拡張する透過的なミドルウェアです。COMはソフトウエア間通信が可能なWindows APIのコンポーネントです。COMを介してクライアントオブジェクトは一般的にDLLやEXEであるサーバオブジェクトのメソッドを呼び出すことができます。
ローカルやリモートのサーバとのCOMオブジェクトとの通信権限はレジストリのACLによって詳細設定されています。デフォルトで管理者のみがリモートからDCOMを介してCOMオブジェクトを有効化し実行できます。

攻撃者は横展開にDCOMを利用します。DCOMを介して攻撃者は適切な特権ユーザのコンテキストの中で行動し、安全ではない方法を含む他のWindowsオブジェクトと同様にOfficeアプリケーションを通じて、リモートから任意のシェルコードを直接実行されます。DCOMは既存のドキュメントでマクロを実行でき、悪意のあるドキュメントの必要性はなくCOMを介して作成されたMicrosoftOfficeアプリケーションのインスタンスを直接実行できるDDEを起動できます。


#### Exploitation of Remote Services

ソフトウエアの脆弱性の悪用により攻撃者は悪意のあるコードを実行するためにプログラムやサービス、OSのソフトウェアまたはカーネル自体のプログラミングエラーを活用します。リモートサービスの情報漏洩させる一般的な目的は、リモートシステムへのアクセスを可能にするために横展開することにあります。
攻撃者はリモートシステムが脆弱な状態かどうか判断する必要があります。ネットワークサービススキャンや他の一般的な探索手法と通して実施したり、ネットワークに展開された脆弱なソフトウェアや脆弱性のパッチの欠如、脆弱性、リモートの攻撃の検知や包含されたセキュリティソフトウェアです。サーバは横展開による搾取のために価値の高いターゲットである可能性が高いですが、エンドポイントシステムは利点や追加のリソースへのアクセスを提供する場合に危険にさらされる可能性があります。

MySQLやWebサーバサービスのような内部ネットワーク内で利用されるアプリケーションと同様にSMBやRDPなどの一般的なサービスに存在するいくつかの既知の脆弱性があります。

脆弱なリモートサービスの権限レベルに応じて、攻撃者は横展開の搾取の結果として権限昇格を達成する可能性があります。


#### Logon Scripts

Windowsでは、特定のユーザやグループがログインする際にログオンスクリプトの実行を設定できます。スクリプトを使用して管理機能を実行することができます。管理機能は他のプログラムを実行したり、内部ログサーバに情報を送信することができます。
攻撃者がこれらのスクリプトにアクセスできた場合に、攻撃者が攻撃者のツールを実行させるためのコードをログオンスクリプトに追加する可能性があります。追加されたコードがローカルスクリプトの場合、システム上での継続的な維持に悪用され、スクリプトが中心的なサーバへの格納や多数システムへの攻撃に利用されたもの場合、ネットワーク内の横展開に悪用されます。ログオンスクリプトのアクセス設定にもよるが、ローカルの資格情報または管理者アカウントが必要になります。

Macでは特定のユーザのログイン、ログオフをフックすることは可能です。Mac OS Xではログインをフックし、ユーザがログインするときにスクリプトを実行することができます。ただし、1回のログインにつき1回しかフックされません。攻撃者がスクリプトにアクセスできた場合、ユーザがログインするときに攻撃者のツールを実行させるスクリプトを追加することができます。


#### Pass the Hash

Pass the Hashはユーザの平文のパスワードを用いずにユーザとして認証する方法です。この方法は平文のパスワードを要求される通常の認証を迂回し、パスワードのハッシュで認証部分に直接移行します。この手法では利用されている正しいパスワードハッシュを資格情報へアクセスする手法を用いてキャプチャされます。一度認証されてしまうとPass the Hashはローカルまたはリモートのシステムで操作することができます。Windows7およびKB2871997以降では正当なドメインユーザかRIDが500であるAdministratorアカウントが求められます。


#### Pass the Tichket

Pass the Ticketはアカウントのパスワードを用いずにKerberosチケットでシステムへの認証を行う方法です。Kerberos認証はリモートシステムへの横展開するため、最初の段階で利用されます。
この手法は資格情報をダンプすることで有効なアカウントの有効なケルベロスチケットを取得します。ユーザのサービスチケットやチケット許可チケット(TGT)はアクセスレベルによって取得できます。サービスチケットは特定リソースへのアクセスを許可しますが、TGTはTicket Granting Service (TGS) からサービスチケットを要求し、ユーザの権限でアクセス可能なすべてのリソースにアクセス可能です。

Sliverチケットは認証メカニズムとしてKerberosを用いたサービスを取得したり、特定のリソースやリソースを提供するシステム(たとえばSharePoint)にアクセス可能なチケットを生成することができます。

Goldenチケットはキー配布サービスアカウントであるKRBTGTのNTLMハッシュを用いて取得でき、Active Directory内の任意のユーザのTGTを生成可能です。


#### Remote Desktop Protocol

リモートデスクトップはOSの一般的な機能です。この機能によりリモートシステムにGUIを用いて対話型セッションにログインできます。マイクロソフトではRemote Desktop Services (RDS)として、Remote Desktop Protocol (RDP)を実装しています。RDSに類似したリモートサービスへのグラフィカルアクセスを提供する他の実装やサードパーティー製のツールもあります。
攻撃者はサービスが有効であったり、既知の資格情報をもつアカウントでアクセスできる場合にRDP/RDSを介してリモートシステムへのアクセスできる範囲を拡大することができます。攻撃者は資格情報を取得するためにRDPを用いて資格情報へアクセスする可能性が高いです。また、攻撃者は持続性のためにユーザ補助機能と連携してRDPを利用します。

攻撃者は正当な利用者のリモートセッションを盗むことを伴うRDPセッションハイジャックを実行することもできます。一般的に第三者のセッションを盗もうとしている場合に利用者へ通知され、プロンプトによる確認が行われます。システム権限でターミナルサービスのコンソールが用いて、c:\windows\system32\tscon.exe [盗むセッション番号]で、攻撃者は資格情報やプロンプトを必要とせずにセッションを乗っ取ることができます。これはリモートまたはローカルや有効または切断されたセッションで実行できます。また、ドメイン管理者以上の権限をもつアカウントのセッションを盗むことでリモートからのシステム検出や権限昇格につながる可能性があります。Windowsコマンドによりすべて実行することができますが、RedSnarfの機能として追加されています。


#### Remote File Copy

ファイルをあるシステムから別のシステムにコピーして、操作の過程で攻撃ツールやほかのファイルを保存することができます。FTPなどの別のツールを用いて代替プロトコルを介して被害者のネットワークにツールを持ち込むためにファイルを外部の攻撃者が管理するシステムからC&Cのチャネルを介してコピーされます。ファイルはMacやLinuxに元々あるscp、rsyncやsftpのようなツールを介してコピーされます。攻撃者は内部の被害者であるシステム間で横展開をサポートするためにリモート実行で接続されたネットワークにSMBを介してのファイル共有やWindows管理共有やRDPを用いた認証された接続を用いてファイルをコピーをします。


#### Remote Services

攻撃者はtelnet、ssh、VNCなどのリモート接続を許可するように特別に設計されたサービスにログインするために、有効なアカウントを使用します。攻撃者はログオンしたユーザとして行動することができてしまいます。


#### Replication Through Removable Media

攻撃者はメディアが別システムに挿入されたときや実行されたときにマルウェアをリムバーブルメディアへコピーしたり、自動実行機能による実行により切断または隔離されたネットワークへ侵入できる可能性があります。これは、リムバーブルメディアに保存されている実行ファイルの変更やマルウェアをコピーして利用者を欺くために正当なファイルのように名前を変更し分離されたシステムでの実行により発生します。


#### SSH Hijacking

Secure Shell(SSH)はLinuxやMacでリモートからアクセスする標準的な手段です。SSHによりユーザは暗号化されたトンネルを介して別のシステムに接続することができ、一般的にパスワード認証、証明書、非対称暗号鍵で認証されます。侵入済みのホストから横展開するために攻撃者は、他のシステムへの既存接続をハイジャックし有効なSSHセッションで公開鍵認証を介した他のシステムと確立された信頼関係を利用することができます。これはSSHエージェント自体を侵害するか、エージェントのソケットにアクセスすることにより発生する可能性があります。攻撃者がrootでのアクセスができた場合に、SSHセッションをハイジャックすることは簡単にできてしまいます。SSHエージェントの危殆化によりSSHの資格情報を傍受するためのアクセスもできます。SSHハイジャックは有効なアカウントでの新しいセッションを作成するのではなく、既存のSSHセッションに挿入するためリモートサービスの利用と異なります。


#### Shared Webroot

攻撃者はWebサイトのWebルートまたはWebコンテンツディレクトリを含むオープンなネットワーク共有を介して内部アクセス可能なWebサイトへ悪意のあるコンテンツを追加できます。そして、Webブラウザによって悪意あるコンテンツへアクセスすることでサーバにより実行させられてしまいます。悪意あるコンテンツは通常、Webサーバのプロセスのコンテキストと権限下で実行され、Webサーバの構成に応じてローカルシステム権限または管理者権限で必要になることがあります。共有アクセスやリモート実行の方法はWebサーバが稼働するシステムへの横展開に利用することができます。例えば、オープンネットワークで共有されているPHPが稼働するWebサーバは、リモートアクセスツールやPHPスクリプトのアップロードや特定ページへのアクセス時にWebサーバを実行しているシステム上でRATを実行させられたりします。


#### Taint Shared Content

ネットワークドライブや別の共有場所に保存されたコンテンツは悪意のあるプログラムやスクリプト、攻撃コードを別の正当なファイルに追加することで汚染される可能性があります。ユーザが汚染されたコンテンツを開くと、悪意のある部分によりリモートシステム上で攻撃者のコードが実行さます。攻撃者は横展開するために共有されたコンテンツを汚染する可能性があります。ディレクトリ共有ピボットは共有されたネットワークディレクトリへユーザがアクセスするときにマルウェアを伝染させるためにいくつかある他の手法の1つです。隠しファイルやディレクトを通して隠された実際のディレクトリのように見せかけるディレクトリ .LNKファイルのショートカットを変更します。悪意のある.LNKベースのディレクトリはディレクトリ内の隠されたマルウェアを実行させたり、ユーザの予想される動作が行われるために実際の意図したディレクトリを開かせる埋め込まれたコマンドがあります。頻繁にネットワークディレクトリを利用すると、頻繁な再感染やシステムや潜在的に新規アカウントや高権限のアカウントへの広範囲なアクセスが発生する可能性があります。


#### Third-party Software

サードバーティー製のアプリケーションやソフトウェアを展開するためのシステムは、管理目的でネットワーク環境で利用されている可能性があります(SCCM、VNC、HBSS、Altirisなど)。攻撃者はこれらのシステムへアクセスできた場合、コードを実行できる可能性があります。攻撃者は企業のネットワーク内にインストールされたサードパーティー製のアプリケーションを展開するためのシステムにアクセスし、悪用される可能性があります。ネットワーク規模または企業規模でソフトウェアを展開するシステムへのアクセスにより、攻撃者はそのようなシステムに接続しているすべてのシステムでリモートからコード実行できます。このアクセスにより横展開に悪用されたり、情報収集やすべてのエンドポイントでのハードドライプから情報を削除するなどの特定の被害を引き起こされる可能性があります。この操作に必要な権限はシステムによって異なります。展開するためのサーバへ直接アクセスすることでローカルの資格情報で十分な場合や特定ドメインの資格情報が必要な場合があります。ただ、システムへのログインやソフトウェアの展開を行うために管理者アカウントが必要な場合があります。


#### Windows Admin Shares

Windowsシステムには管理者のみがアクセス可能な隠れたネットワーク共有があり、リモートからファイルコピーや他の管理機能を提供します。C$、ADMIN$、IPC$を含むネットワーク共有があります。攻撃者はシステムとの通信を行うためにRPCを用いて、SMBでネットワーク化されたシステムにリモートからアクセスするために管理者レベルの有効なアカウントと合わせてこの技術を利用します。SMB/RPC上の認証されたセッションに依存する実行手法の例として、スケジュールされたタスク、サービス実行やWindows Management Instrumentationがあります。攻撃者はシステム上の管理者の共有にアクセスするためにPass the Hashや特定の構成、パッチレベルででNTLMハッシュを利用することもできます。netユーティリティは有効な資格情報でのnet useコマンドによりリモートシステム上のWindows管理者共有に接続するために利用することができます。


#### Windows Remote Management

Windows Remote Management (WinRM)は、ユーザーがリモートのシステムとやりとりできる（実行可能ファイルの実行、レジストリの変更、サービスの変更など）、Windowsサービスやプロトコルの名前です。WinRMはwinrmコマンドまたはPowerShellで任意の数のプログラムで呼び出すことができます。
